--[[
    AMETHYST HUB V2.1 | CHANCE HUTAO PREDICTION
    Dev: DUYBEO
    Base: V1.7 Clean
    Source: Extracted from Hutao-Deobf-V2.3.0.txt
    Settings:
    - Prediction: 0.165 (Hutao Value).
    - Range: 300 (Hutao Value).
    - Logic: Chance Gun Only.
]]

repeat task.wait() until game:IsLoaded()

game.StarterGui:SetCore("SendNotification", {
    Title = "AMETHYST HUB",
    Text = "Loading V2.1 (Hutao Chance)...",
    Duration = 3
})

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- --- UI SETUP (NO ACRYLIC) ---
local Window = Fluent:CreateWindow({
    Title = "AMETHYST HUB V2.1",
    SubTitle = "Forsaken (Hutao Chance)",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = false, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- --- NÚT THU NHỎ ---
do
    local CoreGui = game:GetService("CoreGui")
    if CoreGui:FindFirstChild("AmethystMinimizeUI") then CoreGui.AmethystMinimizeUI:Destroy() end
    local DragUI = Instance.new("ScreenGui", CoreGui)
    DragUI.Name = "AmethystMinimizeUI"
    local Button = Instance.new("ImageButton", DragUI)
    Button.Size = UDim2.fromOffset(50, 50)
    Button.Position = UDim2.fromScale(0.1, 0.1)
    Button.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Button.BackgroundTransparency = 0.3
    Button.Image = "rbxassetid://7733960981"
    Button.Active = true
    Button.MouseButton1Click:Connect(function() Window:Minimize() end)
end

local Tabs = {
    Farm = Window:AddTab({ Title = "Auto Farm", Icon = "sword" }),
    Combat = Window:AddTab({ Title = "Chance Aimbot", Icon = "crosshair" }), 
    Player = Window:AddTab({ Title = "Visuals (ESP)", Icon = "eye" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- =================================================================
-- 1. HUTAO CHANCE AIMBOT (PREDICTION 0.165)
-- =================================================================
do
    -- [HUTAO SETTINGS FROM FILE]
    getgenv().AimbotEnabled = false
    getgenv().PredictAmount = 0.165 -- Giá trị chuẩn từ file Hutao
    getgenv().TargetRange = 300     -- Giá trị chuẩn từ file Hutao
    
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    local LocalPlayer = Players.LocalPlayer
    local Camera = workspace.CurrentCamera
    
    local Aiming = false
    local Target = nil

    local function IsKiller(plr)
        if plr.Team and plr.Team.Name == "Killers" then return true end
        if plr.Character and plr.Character.Parent and plr.Character.Parent.Name == "Killers" then return true end
        return false
    end

    local function GetClosestTarget()
        local closestDist = getgenv().TargetRange
        local closestPlr = nil
        local mousePos = UserInputService:GetMouseLocation()
        
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChild("Humanoid") and plr.Character.Humanoid.Health > 0 then
                if IsKiller(plr) then
                    local part = plr.Character:FindFirstChild("HumanoidRootPart")
                    if part then
                        local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                        if onScreen then
                            local dist = (Vector2.new(mousePos.X, mousePos.Y) - Vector2.new(pos.X, pos.Y)).Magnitude
                            if dist < closestDist then
                                closestDist = dist
                                closestPlr = part -- Aim vào thân để dễ trúng đạn
                            end
                        end
                    end
                end
            end
        end
        return closestPlr
    end

    -- Loop khóa tâm + Prediction
    RunService.RenderStepped:Connect(function()
        if getgenv().AimbotEnabled and Aiming and Target and Target.Parent and Target.Parent:FindFirstChild("Humanoid") and Target.Parent.Humanoid.Health > 0 then
            -- Logic Prediction: Vị trí hiện tại + (Vận tốc * Dự đoán)
            local predictedPosition = Target.Position + (Target.Velocity * getgenv().PredictAmount)
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPosition)
        end
    end)

    -- Trigger khi bấm bắn
    UserInputService.InputBegan:Connect(function(input, processed)
        if processed or not getgenv().AimbotEnabled then return end
        
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            local char = LocalPlayer.Character
            if not char then return end
            
            local tool = char:FindFirstChildOfClass("Tool")
            if tool and tool.Name == "Chance" then -- Chỉ Chance
                Target = GetClosestTarget()
                if Target then
                    Aiming = true
                    -- Giữ khóa tâm lâu hơn một chút để đạn bay (Prediction cần thời gian)
                    task.wait(0.3) 
                    Aiming = false
                    Target = nil
                end
            end
        end
    end)

    Tabs.Combat:AddToggle("AimbotToggle", {
        Title = "Chance Aimbot (Hutao)",
        Description = "Prediction: 0.165 | Range: 300",
        Default = false,
        Callback = function(Value)
            getgenv().AimbotEnabled = Value
        end
    })

    -- Cho phép chỉnh Prediction nếu mạng lag
    Tabs.Combat:AddSlider("PredSlider", {
        Title = "Prediction Amount",
        Description = "Hutao Default: 0.165",
        Default = 0.165,
        Min = 0.1,
        Max = 0.3,
        Rounding = 3,
        Callback = function(Value)
            getgenv().PredictAmount = Value
        end
    })
    
    Tabs.Combat:AddSlider("RangeSlider", {
        Title = "Target Range",
        Description = "Hutao Default: 300",
        Default = 300,
        Min = 100,
        Max = 1000,
        Rounding = 0,
        Callback = function(Value)
            getgenv().TargetRange = Value
        end
    })
end

-- =================================================================
-- 2. AUTO FARM LOGIC (V1.7 CLEAN)
-- =================================================================
do
    local Players = game:GetService("Players")
    local LP = Players.LocalPlayer
    getgenv().AutoFarm = false
    getgenv().ManualFix = false
    local IgnoreList = {} 

    local function GetProgress(gen)
        if not gen then return 100 end
        local p = gen:FindFirstChild("Progress")
        return (p and p:IsA("NumberValue")) and p.Value or 0
    end

    local function GetNextGenerator()
        local closest = 99999
        local target = nil
        local root = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
        if not root then return nil end
        
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj.Name == "Generator" and obj:IsA("Model") then
                if not IgnoreList[obj] and GetProgress(obj) < 100 then
                    local main = obj.PrimaryPart or obj:FindFirstChild("Main")
                    if main then
                        local dist = (root.Position - main.Position).Magnitude
                        if dist < closest then closest = dist; target = obj end
                    end
                end
            end
        end
        return target
    end

    local function StartAutoFarm()
        spawn(function()
            while true do
                task.wait()
                if not getgenv().AutoFarm then break end
                pcall(function()
                    local char = LP.Character
                    local root = char and char:FindFirstChild("HumanoidRootPart")
                    if not root then return end
                    local gen = GetNextGenerator()
                    if gen then
                        local pivot = gen:GetPivot()
                        if pivot then
                            local dropPos = (pivot * CFrame.new(0, 5, -6)).Position
                            local lookAtPos = pivot.Position
                            while getgenv().AutoFarm and (root.Position - dropPos).Magnitude > 3 do
                                root.CFrame = CFrame.lookAt(dropPos, Vector3.new(lookAtPos.X, dropPos.Y, lookAtPos.Z))
                                root.Velocity = Vector3.zero
                                task.wait()
                            end
                            if not getgenv().AutoFarm then return end
                            root.Velocity = Vector3.new(0, -80, 0)
                            task.wait(0.5)
                            
                            local prompt = gen:FindFirstChild("Main") and gen.Main:FindFirstChild("Prompt")
                            if prompt then
                                prompt.RequiresLineOfSight = false
                                prompt.MaxActivationDistance = 99999
                                fireproximityprompt(prompt)
                            end

                            while getgenv().AutoFarm and GetProgress(gen) < 100 do
                                if prompt then pcall(function() prompt:InputHoldBegin() task.wait() prompt:InputHoldEnd() end) end
                                if gen:FindFirstChild("Remotes") and gen.Remotes:FindFirstChild("RE") then gen.Remotes.RE:FireServer() end
                                Fluent:Notify({Title = "Fixing", Content = math.floor(GetProgress(gen)) .. "%", Duration = 1})
                                task.wait(1.5)
                                if (root.Position - pivot.Position).Magnitude > 15 then break end
                            end
                            
                            if GetProgress(gen) >= 100 then
                                IgnoreList[gen] = true
                                Fluent:Notify({Title = "Done", Content = "Next Generator", Duration = 2})
                                task.wait(0.5)
                            end
                        end
                    else
                        getgenv().AutoFarm = false
                        Fluent:Notify({Title = "Completed", Content = "All Generators Fixed!", Duration = 5})
                        Tabs.Farm:SetValues({AutoGenerator = false})
                    end
                end)
            end
        end)
    end

    local function StartManualFix()
        spawn(function()
            while getgenv().ManualFix do
                task.wait(1.5) 
                pcall(function()
                    local char = LP.Character
                    local root = char and char:FindFirstChild("HumanoidRootPart")
                    if not root then return end
                    for _, obj in pairs(workspace:GetDescendants()) do
                        if obj.Name == "Generator" and obj:IsA("Model") then
                            local main = obj.PrimaryPart or obj:FindFirstChild("Main")
                            if main then
                                local dist = (root.Position - main.Position).Magnitude
                                if dist < 15 and GetProgress(obj) < 100 then
                                    if obj:FindFirstChild("Remotes") and obj.Remotes:FindFirstChild("RE") then
                                        obj.Remotes.RE:FireServer()
                                    end
                                end
                            end
                        end
                    end
                end)
            end
        end)
    end

    Tabs.Farm:AddToggle("AutoGenerator", { Title = "Auto Farm (Teleport)", Description = "AFK Mode", Default = false, Callback = function(V) getgenv().AutoFarm = V if V then StartAutoFarm() else if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then LP.Character.HumanoidRootPart.Anchored = false end end end })
    Tabs.Farm:AddToggle("ManualFixToggle", { Title = "Manual Fix Assist", Description = "Legit (1.5s)", Default = false, Callback = function(V) getgenv().ManualFix = V if V then StartManualFix() end end })
    Tabs.Farm:AddButton({Title = "Reset Generator List", Description = "Refresh List", Callback = function() IgnoreList = {} Fluent:Notify({Title = "Reset", Content = "OK!", Duration = 2}) end})
end

-- =================================================================
-- 3. INFINITE STAMINA (V1.7 CLEAN)
-- =================================================================
do
    getgenv().InfStamina = false
    local staminaLoop
    local StaminaModule

    pcall(function()
        local sys = game:GetService("ReplicatedStorage"):FindFirstChild("Systems")
        if sys then StaminaModule = require(sys.Character.Game.Sprinting) end
    end)

    local function restoreStamina()
        if not StaminaModule then return end
        if StaminaModule.Stamina then
            StaminaModule.Stamina = 100
        end
    end

    Tabs.Player:AddToggle("InfStamina", {
        Title = "Infinite Stamina",
        Default = false,
        Callback = function(value)
            getgenv().InfStamina = value
            if StaminaModule then StaminaModule.StaminaLossDisabled = value end
            if value then
                if StaminaModule then
                    restoreStamina()
                    staminaLoop = task.spawn(function()
                        while getgenv().InfStamina do task.wait() restoreStamina() end
                    end)
                end
            else
                if staminaLoop then task.cancel(staminaLoop) end
            end
        end
    })
end

-- =================================================================
-- 4. ESP MANAGER (CLEAN - HIGHLIGHT)
-- =================================================================
do
    getgenv().ESPGen = false
    getgenv().ESPKiller = false
    getgenv().ESPSurvivor = false
    
    local ESPFolder = Instance.new("Folder", game.CoreGui)
    ESPFolder.Name = "AmethystESP_V2.1_Clean"

    local function CreateHighlight(obj, color, nameID, textOverride)
        local espID = nameID or obj:GetDebugId()
        if not ESPFolder:FindFirstChild(espID) then
            local hl = Instance.new("Highlight")
            hl.Name = espID
            hl.Adornee = obj
            hl.Parent = ESPFolder
            hl.FillColor = color
            hl.OutlineColor = Color3.fromRGB(255, 255, 255)
            hl.FillTransparency = 0.5
            hl.OutlineTransparency = 0
            
            local bb = Instance.new("BillboardGui")
            bb.Adornee = obj
            bb.Size = UDim2.new(0, 100, 0, 50)
            bb.StudsOffset = Vector3.new(0, 3, 0)
            bb.AlwaysOnTop = true
            bb.Parent = hl
            
            local txt = Instance.new("TextLabel")
            txt.Size = UDim2.new(1, 0, 1, 0)
            txt.BackgroundTransparency = 1
            txt.TextColor3 = color
            txt.TextStrokeTransparency = 0
            txt.Font = Enum.Font.GothamBold
            txt.TextSize = 12
            txt.Text = textOverride or obj.Name
            txt.Parent = bb

            obj.AncestryChanged:Connect(function(_, parent) if not parent then hl:Destroy() end end)
            return hl
        end
        return nil
    end

    local function IsKiller(player)
        if player.Team and player.Team.Name == "Killers" then return true end
        if player.Character and player.Character.Parent and player.Character.Parent.Name == "Killers" then return true end
        return false
    end

    task.spawn(function()
        while true do
            task.wait(1)
            -- CLEANUP
            for _, hl in pairs(ESPFolder:GetChildren()) do
                if string.find(hl.Name, "_K") and not getgenv().ESPKiller then hl:Destroy() end
                if string.find(hl.Name, "_S") and not getgenv().ESPSurvivor then hl:Destroy() end
                if string.find(hl.Name, "_GEN") and not getgenv().ESPGen then hl:Destroy() end
            end

            -- GENERATOR
            if getgenv().ESPGen then
                for _, obj in pairs(workspace:GetDescendants()) do
                    if obj.Name == "Generator" and obj:IsA("Model") then
                        local progress = obj:FindFirstChild("Progress", true)
                        if progress and progress:IsA("NumberValue") and progress.Value < 100 then
                            local hl = CreateHighlight(obj, Color3.fromRGB(170, 0, 255), obj:GetDebugId().."_GEN", "Generator")
                            if hl then
                                progress.Changed:Connect(function(val) if val >= 100 then hl:Destroy() end end)
                            end
                        end
                    end
                end
            end

            -- PLAYER
            if getgenv().ESPKiller or getgenv().ESPSurvivor then
                for _, plr in pairs(game.Players:GetPlayers()) do
                    if plr ~= game.Players.LocalPlayer and plr.Character and plr.Character:FindFirstChild("Humanoid") then
                        if IsKiller(plr) then
                            if getgenv().ESPKiller then
                                CreateHighlight(plr.Character, Color3.fromRGB(255, 0, 0), plr.Name.."_K")
                            end
                        else
                            if getgenv().ESPSurvivor then
                                CreateHighlight(plr.Character, Color3.fromRGB(0, 255, 255), plr.Name.."_S")
                            end
                        end
                    end
                end
            end
        end
    end)

    Tabs.Player:AddToggle("ESPToggle", { Title = "Generator ESP", Default = false, Callback = function(V) getgenv().ESPGen = V end })
    Tabs.Player:AddToggle("ESPKillerToggle", { Title = "Killer ESP", Default = false, Callback = function(V) getgenv().ESPKiller = V end })
    Tabs.Player:AddToggle("ESPSurvivorToggle", { Title = "Survivor ESP", Default = false, Callback = function(V) getgenv().ESPSurvivor = V end })
end

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({ Title = "AMETHYST HUB", Content = "Loaded V2.1 (Hutao Chance)!", Duration = 5 })
SaveManager:LoadAutoloadConfig()
