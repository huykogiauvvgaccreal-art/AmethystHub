--[[
    AMETHYST HUB V2.4 | FIX LAG & HUTAO ESP
    Dev: DUYBEO
    Base: V2.3
    Updates:
    - FIX LAG: Optimized Scan Loop (1s delay) -> No more screen stuttering.
    - ESP Taph & Builder: 100% Hutao Hub Logic (Name & Color).
]]

game.StarterGui:SetCore("SendNotification", {
    Title = "AMETHYST HUB",
    Text = "Loading V2.4 (Fix Lag)...",
    Duration = 3
})

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- --- 1. SETUP WINDOW ---
local Window = Fluent:CreateWindow({
    Title = "AMETHYST HUB V2.4",
    SubTitle = "Forsaken (No Lag)",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- --- 2. MINIMIZE BUTTON ---
do
    local CoreGui = game:GetService("CoreGui")
    if CoreGui:FindFirstChild("AmethystMinimizeUI") then CoreGui.AmethystMinimizeUI:Destroy() end
    local DragUI = Instance.new("ScreenGui", CoreGui)
    DragUI.Name = "AmethystMinimizeUI"
    local Button = Instance.new("ImageButton", DragUI)
    Button.Size = UDim2.fromOffset(50, 50)
    Button.Position = UDim2.fromScale(0.1, 0.1)
    Button.Image = "rbxassetid://7733960981"
    Button.MouseButton1Click:Connect(function() Window:Minimize() end)
end

local Tabs = {
    Farm = Window:AddTab({ Title = "Auto Farm", Icon = "sword" }),
    Player = Window:AddTab({ Title = "Visuals (ESP)", Icon = "eye" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- --- 3. AUTO FARM LOGIC (V1.7 GỐC - AN TOÀN) ---
do
    local Players = game:GetService("Players")
    local LP = Players.LocalPlayer
    getgenv().AutoFarm = false
    getgenv().ManualFix = false
    local IgnoreList = {} 

    local function GetProgress(gen)
        if not gen then return 100 end
        local p = gen:FindFirstChild("Progress")
        return (p and p:IsA("NumberValue")) and p.Value or 0
    end

    local function GetNextGenerator()
        local closest = 99999
        local target = nil
        local root = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
        if not root then return nil end
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj.Name == "Generator" and obj:IsA("Model") then
                if not IgnoreList[obj] and GetProgress(obj) < 100 then
                    local main = obj.PrimaryPart or obj:FindFirstChild("Main")
                    if main then
                        local dist = (root.Position - main.Position).Magnitude
                        if dist < closest then closest = dist; target = obj end
                    end
                end
            end
        end
        return target
    end

    local function StartAutoFarm()
        spawn(function()
            while true do
                task.wait()
                if not getgenv().AutoFarm then break end
                pcall(function()
                    local char = LP.Character
                    local root = char and char:FindFirstChild("HumanoidRootPart")
                    if not root then return end
                    local gen = GetNextGenerator()
                    if gen then
                        local pivot = gen:GetPivot()
                        if pivot then
                            local dropPos = (pivot * CFrame.new(0, 5, -6)).Position
                            local lookAtPos = pivot.Position
                            while getgenv().AutoFarm and (root.Position - dropPos).Magnitude > 3 do
                                root.CFrame = CFrame.lookAt(dropPos, Vector3.new(lookAtPos.X, dropPos.Y, lookAtPos.Z))
                                root.Velocity = Vector3.zero
                                task.wait()
                            end
                            if not getgenv().AutoFarm then return end
                            root.Velocity = Vector3.new(0, -80, 0)
                            task.wait(0.5)
                            
                            local prompt = gen:FindFirstChild("Main") and gen.Main:FindFirstChild("Prompt")
                            if prompt then
                                prompt.RequiresLineOfSight = false
                                prompt.MaxActivationDistance = 99999
                                fireproximityprompt(prompt)
                            end

                            while getgenv().AutoFarm and GetProgress(gen) < 100 do
                                if prompt then pcall(function() prompt:InputHoldBegin() task.wait() prompt:InputHoldEnd() end) end
                                if gen:FindFirstChild("Remotes") and gen.Remotes:FindFirstChild("RE") then gen.Remotes.RE:FireServer() end
                                Fluent:Notify({Title = "Fixing", Content = math.floor(GetProgress(gen)) .. "%", Duration = 1})
                                task.wait(1.5)
                                if (root.Position - pivot.Position).Magnitude > 15 then break end
                            end
                            
                            if GetProgress(gen) >= 100 then
                                IgnoreList[gen] = true
                                Fluent:Notify({Title = "Done", Content = "Next Generator", Duration = 2})
                                task.wait(0.5)
                            end
                        end
                    else
                        getgenv().AutoFarm = false
                        Fluent:Notify({Title = "Info", Content = "All Fixed!", Duration = 5})
                    end
                end)
            end
        end)
    end

    local function StartManualFix()
        spawn(function()
            while getgenv().ManualFix do
                task.wait(1.5) 
                pcall(function()
                    local char = LP.Character
                    local root = char and char:FindFirstChild("HumanoidRootPart")
                    if not root then return end
                    for _, obj in pairs(workspace:GetDescendants()) do
                        if obj.Name == "Generator" and obj:IsA("Model") then
                            local main = obj.PrimaryPart or obj:FindFirstChild("Main")
                            if main then
                                local dist = (root.Position - main.Position).Magnitude
                                if dist < 15 and GetProgress(obj) < 100 then
                                    if obj:FindFirstChild("Remotes") and obj.Remotes:FindFirstChild("RE") then
                                        obj.Remotes.RE:FireServer()
                                    end
                                end
                            end
                        end
                    end
                end)
            end
        end)
    end

    Tabs.Farm:AddToggle("AutoGenerator", { Title = "Auto Farm (Teleport)", Description = "AFK Mode", Default = false, Callback = function(V) getgenv().AutoFarm = V if V then StartAutoFarm() else if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then LP.Character.HumanoidRootPart.Anchored = false end end end })
    Tabs.Farm:AddToggle("ManualFixToggle", { Title = "Manual Fix Assist", Description = "Legit (1.5s)", Default = false, Callback = function(V) getgenv().ManualFix = V if V then StartManualFix() end end })
    Tabs.Farm:AddButton({Title = "Reset List", Description = "Refresh", Callback = function() IgnoreList = {} Fluent:Notify({Title = "Reset", Content = "OK!", Duration = 2}) end})
end

-- --- 4. INFINITE STAMINA (HUTAO) ---
do
    getgenv().InfStamina = false
    local function HutaoStamina()
        spawn(function()
            while getgenv().InfStamina do
                task.wait()
                pcall(function()
                    local SprintSystem = require(game:GetService("ReplicatedStorage").Systems.Character.Game.Sprinting)
                    if SprintSystem then
                        SprintSystem.Stamina = 100 
                        SprintSystem.StaminaLossDisabled = true 
                    end
                end)
            end
        end)
    end
    Tabs.Player:AddToggle("InfStamina", { Title = "Infinite Stamina (Hutao)", Default = false, Callback = function(V) getgenv().InfStamina = V if V then HutaoStamina() end end })
end

-- --- 5. ESP MANAGER (OPTIMIZED + HUTAO LOGIC) ---
do
    getgenv().ESPGen = false
    getgenv().ESPKiller = false
    getgenv().ESPSurvivor = false
    getgenv().ESPClone = false
    getgenv().ESPTaph = false
    getgenv().ESPBuilder = false
    
    local ESPFolder = Instance.new("Folder", game.CoreGui)
    ESPFolder.Name = "AmethystESP_V2.4"

    local CloneModels = {
        ["1x1x1x1Zombie"] = true, ["PizzaDeliveryRig"] = true,
        ["Mafia1"] = true, ["Mafia2"] = true, ["Mafia3"] = true, ["Mafia4"] = true,
        ["Guest1337"] = true, ["Noob"] = true 
    }

    local function CreateHighlight(obj, color, nameID, textOverride)
        local espID = nameID or obj:GetDebugId()
        if not ESPFolder:FindFirstChild(espID) then
            local hl = Instance.new("Highlight")
            hl.Name = espID
            hl.Adornee = obj
            hl.Parent = ESPFolder
            hl.FillColor = color
            hl.OutlineColor = Color3.fromRGB(255, 255, 255)
            hl.FillTransparency = 0.5
            hl.OutlineTransparency = 0
            
            local bb = Instance.new("BillboardGui")
            bb.Adornee = obj
            bb.Size = UDim2.new(0, 100, 0, 50)
            bb.StudsOffset = Vector3.new(0, 3, 0)
            bb.AlwaysOnTop = true
            bb.Parent = hl
            
            local txt = Instance.new("TextLabel")
            txt.Size = UDim2.new(1, 0, 1, 0)
            txt.BackgroundTransparency = 1
            txt.TextColor3 = color
            txt.TextStrokeTransparency = 0
            txt.Font = Enum.Font.GothamBold
            txt.TextSize = 12
            txt.Text = textOverride or obj.Name
            txt.Parent = bb

            obj.AncestryChanged:Connect(function(_, parent) if not parent then hl:Destroy() end end)
            return hl
        end
        return nil
    end

    local function IsKiller(player)
        if player.Team and player.Team.Name == "Killers" then return true end
        if player.Character and player.Character.Parent and player.Character.Parent.Name == "Killers" then return true end
        return false
    end

    -- LOOP QUÉT TỐI ƯU (1 GIÂY/LẦN ĐỂ KHÔNG KHỰNG)
    task.spawn(function()
        while true do
            -- FIX LAG: Chỉ quét mỗi 1 giây thay vì mỗi khung hình
            task.wait(1) 
            
            -- XÓA KHI TẮT
            for _, hl in pairs(ESPFolder:GetChildren()) do
                if string.find(hl.Name, "_K") and not getgenv().ESPKiller then hl:Destroy() end
                if string.find(hl.Name, "_S") and not getgenv().ESPSurvivor then hl:Destroy() end
                if string.find(hl.Name, "_C") and not getgenv().ESPClone then hl:Destroy() end
                if string.find(hl.Name, "_GEN") and not getgenv().ESPGen then hl:Destroy() end
                if string.find(hl.Name, "_Trap") and not getgenv().ESPTaph then hl:Destroy() end
                if string.find(hl.Name, "_Bomb") and not getgenv().ESPTaph then hl:Destroy() end
                if string.find(hl.Name, "_Sentry") and not getgenv().ESPBuilder then hl:Destroy() end
                if string.find(hl.Name, "_Heal") and not getgenv().ESPBuilder then hl:Destroy() end
            end

            -- CHỈ QUÉT NẾU CÓ BẬT ÍT NHẤT 1 ESP
            if getgenv().ESPGen or getgenv().ESPClone or getgenv().ESPTaph or getgenv().ESPBuilder then
                for _, obj in pairs(workspace:GetDescendants()) do
                    if obj:IsA("Model") then
                        -- GEN
                        if getgenv().ESPGen and obj.Name == "Generator" then
                            local p = obj:FindFirstChild("Progress")
                            if p and p.Value < 100 then CreateHighlight(obj, Color3.fromRGB(170,0,255), obj:GetDebugId().."_GEN", "Generator") end
                        end
                        
                        -- CLONE (Hutao)
                        if getgenv().ESPClone and CloneModels[obj.Name] then
                            CreateHighlight(obj, Color3.fromRGB(0,255,0), obj.Name.."_C", "CLONE")
                        end

                        -- TAPH (Hutao Code)
                        if getgenv().ESPTaph then
                            if obj.Name:find("TaphTripwire") then
                                CreateHighlight(obj, Color3.fromRGB(255,85,0), obj:GetDebugId().."_Trap", "TRAP")
                            elseif obj.Name == "SubspaceTripmine" then
                                CreateHighlight(obj, Color3.fromRGB(160,32,240), obj:GetDebugId().."_Bomb", "BOMB")
                            end
                        end

                        -- BUILDER (Hutao Code)
                        if getgenv().ESPBuilder then
                            local ln = obj.Name:lower()
                            if ln:find("sentry") then
                                CreateHighlight(obj, Color3.fromRGB(128,128,128), obj:GetDebugId().."_Sentry", "SENTRY")
                            elseif ln:find("dispenser") then
                                CreateHighlight(obj, Color3.fromRGB(0,162,255), obj:GetDebugId().."_Heal", "DISPENSER")
                            end
                        end
                    end
                end
            end

            -- PLAYER (Quét riêng từ danh sách người chơi)
            if getgenv().ESPKiller or getgenv().ESPSurvivor then
                for _, plr in pairs(game.Players:GetPlayers()) do
                    if plr ~= game.Players.LocalPlayer and plr.Character and plr.Character:FindFirstChild("Humanoid") then
                        if IsKiller(plr) then
                            if getgenv().ESPKiller then CreateHighlight(plr.Character, Color3.fromRGB(255,0,0), plr.Name.."_K") end
                        else
                            if getgenv().ESPSurvivor then CreateHighlight(plr.Character, Color3.fromRGB(0,255,255), plr.Name.."_S") end
                        end
                    end
                end
            end
        end
    end)

    Tabs.Player:AddToggle("ESPToggle", { Title = "Generator ESP", Default = false, Callback = function(V) getgenv().ESPGen = V end })
    Tabs.Player:AddToggle("ESPKillerToggle", { Title = "Killer ESP", Default = false, Callback = function(V) getgenv().ESPKiller = V end })
    Tabs.Player:AddToggle("ESPSurvivorToggle", { Title = "Survivor ESP", Default = false, Callback = function(V) getgenv().ESPSurvivor = V end })
    Tabs.Player:AddToggle("ESPCloneToggle", { Title = "Clone ESP (Hutao)", Default = false, Callback = function(V) getgenv().ESPClone = V end })
    Tabs.Player:AddToggle("ESPTaph", { Title = "Taph ESP (Hutao)", Description = "Fix Lag", Default = false, Callback = function(V) getgenv().ESPTaph = V end })
    Tabs.Player:AddToggle("ESPBuilder", { Title = "Builder ESP (Hutao)", Description = "Fix Lag", Default = false, Callback = function(V) getgenv().ESPBuilder = V end })
end

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
Window:SelectTab(1)

Fluent:Notify({ Title = "AMETHYST HUB", Content = "Loaded V2.4 (Fix Lag)!", Duration = 5 })
SaveManager:LoadAutoloadConfig()
