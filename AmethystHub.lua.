--[[
    AMETHYST HUB V2.1 | HUTAO LOGIC
    Dev: DUYBEO
    Updates:
    - ESP Taph & Builder: Updated to use exact Hutao Hub logic (Lines 445-446).
    - Features: Auto Farm V15, Manual Fix (Legit), Smart ESP (Optimized).
]]

game.StarterGui:SetCore("SendNotification", {
    Title = "AMETHYST HUB",
    Text = "Loading V2.1 (Hutao Logic)...",
    Duration = 3
})

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Window = Fluent:CreateWindow({
    Title = "AMETHYST HUB V2.1",
    SubTitle = "Forsaken Script (Hutao Logic)",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- --- MINIMIZE BUTTON ---
do
    local CoreGui = game:GetService("CoreGui")
    local TweenService = game:GetService("TweenService")
    if CoreGui:FindFirstChild("AmethystMinimizeUI") then CoreGui.AmethystMinimizeUI:Destroy() end
    local DragUI = Instance.new("ScreenGui", CoreGui)
    DragUI.Name = "AmethystMinimizeUI"
    local Button = Instance.new("ImageButton", DragUI)
    Button.Size = UDim2.fromOffset(50, 50)
    Button.Position = UDim2.fromScale(0.1, 0.1)
    Button.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Button.BackgroundTransparency = 0.3
    Button.Image = "rbxassetid://7733960981"
    Button.ImageColor3 = Color3.fromRGB(170, 0, 255)
    Instance.new("UICorner", Button).CornerRadius = UDim.new(1, 0)
    
    local dragging, dragInput, dragStart, startPos
    Button.InputBegan:Connect(function(input) 
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; dragStart = input.Position; startPos = Button.Position
        end
    end)
    Button.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            Button.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    Button.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end end)
    Button.MouseButton1Click:Connect(function() 
        Window:Minimize()
        TweenService:Create(Button, TweenInfo.new(0.1), {Size = UDim2.fromOffset(45,45), Rotation = 10}):Play()
        task.wait(0.1)
        TweenService:Create(Button, TweenInfo.new(0.1), {Size = UDim2.fromOffset(50,50), Rotation = 0}):Play()
    end)
end

local Tabs = {
    Farm = Window:AddTab({ Title = "Auto Farm", Icon = "sword" }),
    Player = Window:AddTab({ Title = "Visuals (ESP)", Icon = "eye" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- --- FARM LOGIC ---
do
    local Players = game:GetService("Players")
    local LP = Players.LocalPlayer
    getgenv().AutoFarm = false
    getgenv().ManualFix = false
    local IgnoreList = {} 

    local function GetProgress(gen)
        if not gen then return 100 end
        local p = gen:FindFirstChild("Progress")
        return (p and p:IsA("NumberValue")) and p.Value or 0
    end

    local function GetNextGenerator()
        local closest = 99999
        local target = nil
        local root = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
        if not root then return nil end
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj.Name == "Generator" and obj:IsA("Model") then
                if not IgnoreList[obj] and GetProgress(obj) < 100 then
                    local main = obj.PrimaryPart or obj:FindFirstChild("Main")
                    if main then
                        local dist = (root.Position - main.Position).Magnitude
                        if dist < closest then closest = dist; target = obj end
                    end
                end
            end
        end
        return target
    end

    local function StartAutoFarm()
        spawn(function()
            while true do
                task.wait()
                if not getgenv().AutoFarm then break end
                pcall(function()
                    local char = LP.Character
                    local root = char and char:FindFirstChild("HumanoidRootPart")
                    if not root then return end
                    local gen = GetNextGenerator()
                    if gen then
                        local pivot = gen:GetPivot()
                        if pivot then
                            local dropPos = (pivot * CFrame.new(0, 5, -6)).Position
                            local lookAtPos = pivot.Position
                            while getgenv().AutoFarm and (root.Position - dropPos).Magnitude > 3 do
                                root.CFrame = CFrame.lookAt(dropPos, Vector3.new(lookAtPos.X, dropPos.Y, lookAtPos.Z))
                                root.Velocity = Vector3.zero
                                task.wait()
                            end
                            if not getgenv().AutoFarm then return end
                            root.Velocity = Vector3.new(0, -80, 0)
                            task.wait(0.5)
                            if (root.Position - pivot.Position).Magnitude < 15 then
                                local prompt = gen:FindFirstChild("Main") and gen.Main:FindFirstChild("Prompt")
                                if prompt then
                                    prompt.RequiresLineOfSight = false
                                    prompt.MaxActivationDistance = 99999
                                    fireproximityprompt(prompt)
                                end
                                while getgenv().AutoFarm and GetProgress(gen) < 100 do
                                    if prompt then pcall(function() prompt:InputHoldBegin() task.wait() prompt:InputHoldEnd() end) end
                                    if gen:FindFirstChild("Remotes") and gen.Remotes:FindFirstChild("RE") then gen.Remotes.RE:FireServer() end
                                    Fluent:Notify({Title = "Progress", Content = math.floor(GetProgress(gen)) .. "%", Duration = 1})
                                    task.wait(1.5)
                                    if (root.Position - pivot.Position).Magnitude > 15 then break end
                                end
                                if GetProgress(gen) >= 100 then
                                    IgnoreList[gen] = true
                                    Fluent:Notify({Title = "Done", Content = "Next Generator", Duration = 2})
                                    task.wait(0.5)
                                end
                            end
                        end
                    else
                        getgenv().AutoFarm = false
                        Fluent:Notify({Title = "Info", Content = "All Generators Fixed!", Duration = 5})
                        Tabs.Farm:SetValues({AutoGenerator = false})
                    end
                end)
            end
        end)
    end

    local function StartManualFix()
        spawn(function()
            while getgenv().ManualFix do
                task.wait(1.5) 
                pcall(function()
                    local char = LP.Character
                    local root = char and char:FindFirstChild("HumanoidRootPart")
                    if not root then return end
                    for _, obj in pairs(workspace:GetDescendants()) do
                        if obj.Name == "Generator" and obj:IsA("Model") then
                            local main = obj.PrimaryPart or obj:FindFirstChild("Main")
                            if main then
                                local dist = (root.Position - main.Position).Magnitude
                                if dist < 15 and GetProgress(obj) < 100 then
                                    if obj:FindFirstChild("Remotes") and obj.Remotes:FindFirstChild("RE") then
                                        obj.Remotes.RE:FireServer()
                                    end
                                end
                            end
                        end
                    end
                end)
            end
        end)
    end

    Tabs.Farm:AddToggle("AutoGenerator", { Title = "Auto Farm (Teleport)", Description = "AFK Mode", Default = false, Callback = function(V) getgenv().AutoFarm = V if V then StartAutoFarm() else if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then LP.Character.HumanoidRootPart.Anchored = false end end end })
    Tabs.Farm:AddToggle("ManualFixToggle", { Title = "Manual Fix Assist", Description = "Legit Mode (1.5s)", Default = false, Callback = function(V) getgenv().ManualFix = V if V then StartManualFix() Fluent:Notify({Title = "Manual Fix", Content = "ON", Duration = 3}) end end })
end

-- --- STAMINA ---
do
    getgenv().InfStamina = false
    local staminaLoop, StaminaModule
    pcall(function()
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local path = ReplicatedStorage:FindFirstChild("Systems") and ReplicatedStorage.Systems:FindFirstChild("Character") and ReplicatedStorage.Systems.Character:FindFirstChild("Game") and ReplicatedStorage.Systems.Character.Game:FindFirstChild("Sprinting")
        if path then StaminaModule = require(path) end
    end)
    Tabs.Player:AddToggle("InfStamina", { Title = "Infinite Stamina", Default = false, Callback = function(V) getgenv().InfStamina = V if StaminaModule and StaminaModule.StaminaLossDisabled ~= nil then StaminaModule.StaminaLossDisabled = V end if V then if StaminaModule then staminaLoop = task.spawn(function() while getgenv().InfStamina do task.wait() if StaminaModule.Stamina then StaminaModule.Stamina = StaminaModule.MaxStamina or 100 end end end) Fluent:Notify({Title = "Stamina", Content = "Active", Duration = 3}) end else if staminaLoop then task.cancel(staminaLoop) end end end })
end

-- --- ESP SYSTEM (HUTAO LOGIC INTEGRATED) ---
do
    getgenv().ESPGen = false
    getgenv().ESPKiller = false
    getgenv().ESPSurvivor = false
    getgenv().ESPClone = false
    getgenv().ESPTaph = false
    getgenv().ESPBuilder = false
    
    local ESPFolder = Instance.new("Folder", game.CoreGui)
    ESPFolder.Name = "AmethystESP_V2.1"

    local CloneModels = {["1x1x1x1Zombie"]=true, ["PizzaDeliveryRig"]=true, ["Mafia1"]=true, ["Mafia2"]=true, ["Mafia3"]=true, ["Mafia4"]=true}
    
    local function IsInMatch()
        local plrs = workspace:FindFirstChild("Players")
        return plrs and (plrs:FindFirstChild("Survivors") or plrs:FindFirstChild("Killers"))
    end

    local function CreateHighlight(obj, color, nameID, textOverride)
        local espID = nameID or obj:GetDebugId()
        if ESPFolder:FindFirstChild(espID) then return end
        
        local hl = Instance.new("Highlight", ESPFolder)
        hl.Name = espID; hl.Adornee = obj; hl.FillColor = color; hl.OutlineColor = Color3.new(1,1,1)
        hl.FillTransparency = 0.5; hl.OutlineTransparency = 0
        
        local bb = Instance.new("BillboardGui", hl)
        bb.Adornee = obj; bb.Size = UDim2.new(0,100,0,50); bb.StudsOffset = Vector3.new(0,2,0); bb.AlwaysOnTop = true
        
        local txt = Instance.new("TextLabel", bb)
        txt.Size = UDim2.new(1,0,1,0); txt.BackgroundTransparency = 1; txt.TextColor3 = color
        txt.TextStrokeTransparency = 0; txt.Font = Enum.Font.GothamBold; txt.TextSize = 11
        txt.Text = textOverride or obj.Name

        obj.AncestryChanged:Connect(function(_, p) if not p then hl:Destroy() end end)
    end

    local function IsKiller(model)
        local k = workspace:FindFirstChild("Players") and workspace.Players:FindFirstChild("Killers")
        return k and model.Parent == k
    end

    task.spawn(function()
        while true do
            task.wait(2) -- Optimized Loop
            
            if not IsInMatch() then
                ESPFolder:ClearAllChildren()
                continue
            end

            -- Clean up
            for _, hl in pairs(ESPFolder:GetChildren()) do
                if string.find(hl.Name, "_K") and not getgenv().ESPKiller then hl:Destroy() end
                if string.find(hl.Name, "_S") and not getgenv().ESPSurvivor then hl:Destroy() end
                if string.find(hl.Name, "_C") and not getgenv().ESPClone then hl:Destroy() end
                if string.find(hl.Name, "_GEN") and not getgenv().ESPGen then hl:Destroy() end
                if (string.find(hl.Name, "_Trap") or string.find(hl.Name, "_Bomb")) and not getgenv().ESPTaph then hl:Destroy() end
                if (string.find(hl.Name, "_Sentry") or string.find(hl.Name, "_Heal")) and not getgenv().ESPBuilder then hl:Destroy() end
            end

            -- Single Scan
            if getgenv().ESPGen or getgenv().ESPKiller or getgenv().ESPSurvivor or getgenv().ESPTaph or getgenv().ESPBuilder or getgenv().ESPClone then
                
                for _, obj in pairs(workspace:GetDescendants()) do
                    if not obj:IsA("Model") and not obj:IsA("BasePart") then continue end
                    local lowerName = obj.Name:lower()

                    -- GENERATOR
                    if getgenv().ESPGen and lowerName == "generator" and obj:IsA("Model") then
                        local p = obj:FindFirstChild("Progress")
                        if p and p.Value < 100 then CreateHighlight(obj, Color3.fromRGB(170,0,255), obj:GetDebugId().."_GEN", "Generator") end
                    
                    -- TAPH (Trap & Bomb) - LOGIC HUTAO (Line 445)
                    elseif getgenv().ESPTaph and obj:IsA("Model") then
                        -- Tripwire (Bẫy dây)
                        if obj.Name:find("TaphTripwire") then
                            CreateHighlight(obj, Color3.fromRGB(255, 85, 0), obj:GetDebugId().."_Trap", "TRAP (Taph)")
                        -- Bomb (Subspace)
                        elseif obj.Name == "SubspaceTripmine" then
                            CreateHighlight(obj, Color3.fromRGB(160, 32, 240), obj:GetDebugId().."_Bomb", "BOMB")
                        end

                    -- BUILDERMAN (Sentry & Dispenser) - LOGIC HUTAO (Line 445)
                    elseif getgenv().ESPBuilder and obj:IsA("Model") then
                        -- Dispenser (Trụ Hồi Máu)
                        if lowerName:find("dispenser") then
                            CreateHighlight(obj, Color3.fromRGB(0, 162, 255), obj:GetDebugId().."_Heal", "DISPENSER")
                        -- Sentry (Trụ Súng)
                        elseif lowerName:find("sentry") then
                            CreateHighlight(obj, Color3.fromRGB(128, 128, 128), obj:GetDebugId().."_Sentry", "SENTRY")
                        end

                    -- CLONE
                    elseif getgenv().ESPClone and obj:IsA("Model") and CloneModels[obj.Name] then
                        CreateHighlight(obj, Color3.fromRGB(0,255,0), obj.Name.."_C", "NPC")
                    end
                end

                -- PLAYERS
                if getgenv().ESPKiller then
                    local k = workspace:FindFirstChild("Players") and workspace.Players:FindFirstChild("Killers")
                    if k then for _,v in pairs(k:GetChildren()) do CreateHighlight(v, Color3.fromRGB(255,0,0), v.Name.."_K") end end
                end

                if getgenv().ESPSurvivor then
                    local s = workspace:FindFirstChild("Players") and workspace.Players:FindFirstChild("Survivors")
                    local LP = game.Players.LocalPlayer
                    if s then 
                        for _,v in pairs(s:GetChildren()) do 
                            if v.Name ~= LP.Name and not IsKiller(v) then CreateHighlight(v, Color3.fromRGB(0,255,255), v.Name.."_S") end 
                        end 
                    end
                end
            end
        end
    end)

    Tabs.Player:AddToggle("ESPToggle", { Title = "Generator ESP", Default = false, Callback = function(V) getgenv().ESPGen = V end })
    Tabs.Player:AddToggle("ESPTaph", { Title = "Taph ESP (Trap/Bomb)", Default = false, Callback = function(V) getgenv().ESPTaph = V end })
    Tabs.Player:AddToggle("ESPBuilder", { Title = "Builder ESP (Sentry/Heal)", Default = false, Callback = function(V) getgenv().ESPBuilder = V end })
    Tabs.Player:AddToggle("ESPKillerToggle", { Title = "Killer ESP", Default = false, Callback = function(V) getgenv().ESPKiller = V end })
    Tabs.Player:AddToggle("ESPSurvivorToggle", { Title = "Survivor ESP", Default = false, Callback = function(V) getgenv().ESPSurvivor = V end })
    Tabs.Player:AddToggle("ESPCloneToggle", { Title = "Clone/NPC ESP", Default = false, Callback = function(V) getgenv().ESPClone = V end })
end

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({ Title = "AMETHYST HUB", Content = "Loaded V2.1 (Hutao Logic)", Duration = 5 })
SaveManager:LoadAutoloadConfig()
